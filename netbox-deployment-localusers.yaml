apiVersion: apps/v1
kind: Deployment
metadata:
  name: netbox
  namespace: netbox-actividad3
  labels:
    k8s-app: netbox
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: netbox
  template:
    metadata:
      labels:
        k8s-app: netbox
    spec:
      containers:
        - name: netbox
          image: quay.io/netboxcommunity/netbox:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
          envFrom:
            - configMapRef:
                name: netbox-config
            - secretRef:
                name: netbox-secrets
          env:
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: netbox-secrets
                  key: db_password
            - name: SUPERUSER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: netbox-secrets
                  key: superuser_password
            - name: DB_HOST
              valueFrom:
                configMapKeyRef:
                  name: netbox-config
                  key: DB_HOST
            - name: DB_NAME
              valueFrom:
                configMapKeyRef:
                  name: netbox-config
                  key: DB_NAME
            - name: DB_USER
              valueFrom:
                configMapKeyRef:
                  name: netbox-config
                  key: DB_USER
            - name: DB_PORT
              valueFrom:
                configMapKeyRef:
                  name: netbox-config
                  key: DB_PORT
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: netbox-secrets
                  key: secret_key

          volumeMounts:
            - name: media
              mountPath: /opt/netbox/netbox/media
            - name: redis-password
              mountPath: /run/secrets/redis_password
              subPath: redis_password
      initContainers:
        - name: netbox-init
          image: quay.io/netboxcommunity/netbox:latest
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: netbox-config
            - secretRef:
                name: netbox-secrets
          env:
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: netbox-secrets
                  key: db_password
            - name: SUPERUSER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: netbox-secrets
                  key: superuser_password
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: netbox-secrets
                  key: secret_key
          volumeMounts:
            - name: media
              mountPath: /opt/netbox/netbox/media
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Running migrations..."
              python3 /opt/netbox/netbox/manage.py migrate --noinput
              echo "Collecting static..."
              python3 /opt/netbox/netbox/manage.py collectstatic --noinput
              echo "Creating superuser if not exists..."
              python3 /opt/netbox/netbox/manage.py shell -c "from django.contrib.auth import get_user_model; User = get_user_model(); u='${SUPERUSER_NAME}'; e='${SUPERUSER_EMAIL}'; p='${SUPERUSER_PASSWORD}'; \
                print('checking for',u); \
                exists = User.objects.filter(username=u).exists(); \
                (User.objects.create_superuser(u,e,p) if not exists else print('superuser exists'))"
      volumes:
        - name: media
          persistentVolumeClaim:
            claimName: netbox-media-pvc
        - name: redis-password
          secret:
            secretName: netbox-redis
            items:
              - key: redis-password
                path: redis_password
